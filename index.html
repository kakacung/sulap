<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>XZ1 Tarot Lite</title>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #start-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 24px; background: #fff; color: #000;
            border: 2px solid #000; font-weight: bold; cursor: pointer; z-index: 100;
        }
        
        #ui {
            position: absolute; bottom: 50px; width: 100%; text-align: center;
            color: #fff; font-weight: bold; font-size: 18px;
            pointer-events: none; display: none; z-index: 10;
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>
<body>

    <button id="start-btn">MULAI</button>
    <div id="ui">ðŸ‘‰ Geser Kiri Buka | âœŠ Genggam Pilih</div>

    <!-- Three.js (Versi Ringan) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r105/three.min.js"></script>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        // --- SETUP 3D (SIMPLE & FAST) ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 10;

        const renderer = new THREE.WebGLRenderer({ antialias: false }); // Matikan Antialias biar ringan
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lampu Sederhana (Biar nggak berat)
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // --- KARTU ---
        const cardData = ["0", "I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X", "XI", "XII", "XIII", "XIV", "XV", "XVI", "XVII", "XVIII", "XIX", "XX", "XXI"];
        const cards = [];
        const geometry = new THREE.BoxGeometry(1.2, 2, 0.1); // Sedikit lebih tebal biar gampang dilihat

        // Fungsi tekstur simpel
        function createTextTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 200; // Kecilkan resolusi tekstur
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ddd'; ctx.fillRect(0,0,128,200);
            ctx.fillStyle = '#000'; ctx.font = 'bold 40px Arial'; ctx.textAlign = 'center';
            ctx.fillText(text, 64, 110);
            return new THREE.CanvasTexture(canvas);
        }

        const material = new THREE.MeshLambertMaterial({ map: createTextTexture("0") }); // Base material
        const backMat = new THREE.MeshLambertMaterial({ color: 0x333333 });
        const edgeMat = new THREE.MeshLambertMaterial({ color: 0x000000 });

        cardData.forEach((num, i) => {
            const frontMat = new THREE.MeshLambertMaterial({ map: createTextTexture(num) });
            const mesh = new THREE.Mesh(geometry, [edgeMat, edgeMat, edgeMat, edgeMat, frontMat, backMat]);
            mesh.userData = { id: i, selected: false };
            mesh.position.y = i * 0.05; 
            scene.add(mesh);
            cards.push(mesh);
        });

        // Cursor
        const cursorGeo = new THREE.CircleGeometry(0.2, 8);
        const cursorMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const cursor = new THREE.Mesh(cursorGeo, cursorMat);
        scene.add(cursor);

        // --- LOGIC ---
        let handX = 0, handY = 0;
        let isFist = false;
        let mode = 'stack';
        let time = 0;

        // --- HAND TRACKING ---
        const video = document.createElement('video');
        
        // SETUP MediaPipe
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        // PENGATURAN KRUSIAL UNTUK HP LAMA
        hands.setOptions({ 
            maxNumHands: 1, 
            modelComplexity: 0, // <--- INI RAHASIANYA (0 = Paling ringan, 1 = Sedang)
            minDetectionConfidence: 0.5, 
            minTrackingConfidence: 0.5 
        });
        
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                handX = lm[8].x;
                handY = lm[8].y;
                
                // Logic Fist
                const dx = lm[8].x - lm[0].x;
                const dy = lm[8].y - lm[0].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const fistNow = dist < 0.2;

                if (fistNow && !isFist && mode === 'wheel') {
                    mode = 'select';
                    selectCard();
                }
                if (!fistNow && isFist && mode === 'select') {
                    mode = 'wheel';
                    resetCard();
                }
                isFist = fistNow;

                if (mode === 'stack' && handX < 0.2) {
                    mode = 'wheel';
                }
            }
        });

        function selectCard() {
            let minDist = 999;
            let target = null;
            cards.forEach(c => {
                const d = c.position.distanceTo(cursor.position);
                if(d < minDist) { minDist = d; target = c; }
            });
            if(target) {
                target.userData.selected = true;
                target.position.set(0, 0, 4);
                target.scale.set(2, 2, 2);
            }
        }

        function resetCard() {
            cards.forEach(c => {
                c.userData.selected = false;
                c.scale.set(1, 1, 1);
            });
        }

        // --- ANIMASI (DIPERCEPAT) ---
        function animate() {
            requestAnimationFrame(animate);
            time += 0.03; // Sedikit lebih cepat biar terasa responsif

            // Cursor
            const targetX = (handX - 0.5) * 12;
            const targetY = -(handY - 0.5) * 6;
            cursor.position.x += (targetX - cursor.position.x) * 0.3;
            cursor.position.y += (targetY - cursor.position.y) * 0.3;

            cards.forEach((c, i) => {
                if (mode === 'stack') {
                    c.position.x += (0 - c.position.x) * 0.1;
                    c.position.y += (i*0.05 - c.position.y) * 0.1;
                    c.position.z += (0 - c.position.z) * 0.1;
                } 
                else if (mode === 'wheel') {
                    const angle = (i / cards.length) * Math.PI * 2 + time * 0.5; 
                    const radius = 4;
                    const tx = Math.sin(angle) * radius;
                    const ty = Math.cos(angle) * (radius * 0.4);
                    const tz = Math.cos(angle) * 1;

                    c.position.x += (tx - c.position.x) * 0.1; // Lebih agresif geraknya
                    c.position.y += (ty - c.position.y) * 0.1;
                    c.position.z += (tz - c.position.z) * 0.1;

                    c.rotation.y = -angle + Math.PI/2; 
                    c.rotation.x = Math.sin(angle) * 0.2;
                }
                else if (mode === 'select') {
                    if(!c.userData.selected) {
                        c.position.z = -10; 
                    } else {
                        c.rotation.y += 0.1;
                    }
                }
            });

            renderer.render(scene, camera);
        }
        animate();

        // --- START BUTTON (FORCE FRONT CAM LOW RES) ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-btn');
            
            try {
                // Paksa Kamera Depan Resolusi RENDAH (Penting buat XZ1)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 320 }, // Resolusi kecil
                        height: { ideal: 240 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                await video.play();

                btn.style.display = 'none';
                document.getElementById('ui').style.display = 'block';

                const cameraUtils = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 320, 
                    height: 240
                });
                cameraUtils.start();

            } catch (e) {
                btn.innerText = "ERROR KAMERA";
                console.error(e);
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
