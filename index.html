<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cyber Tarot 2077</title>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        #start-btn {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 15px 30px; font-size: 20px; background: #0ff; color: #000;
            border: none; font-weight: bold; cursor: pointer; z-index: 100;
            box-shadow: 0 0 20px #0ff; text-transform: uppercase; letter-spacing: 2px;
        }
        
        #ui {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            color: #0ff; font-weight: bold; text-shadow: 0 0 10px #0ff;
            pointer-events: none; display: none; z-index: 10;
        }
    </style>
</head>
<body>

    <button id="start-btn">MULAI SULAP</button>
    <div id="ui">ðŸ‘‹ Gerak Tangan | âœŠ Genggam buat Pilih</div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script>
        // --- SETUP 3D ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.05);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 8;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lampu Neon
        const light1 = new THREE.PointLight(0x00ffff, 2, 20); // Cyan
        light1.position.set(5, 5, 5);
        scene.add(light1);
        const light2 = new THREE.PointLight(0xff00ff, 2, 20); // Magenta
        light2.position.set(-5, -5, 5);
        scene.add(light2);

        // --- KARTU ---
        const cardData = [
            "THE FOOL", "THE MAGICIAN", "PRIESTESS", "EMPRESS", "EMPEROR", 
            "HIEROPHANT", "LOVERS", "CHARIOT", "STRENGTH", "HERMIT", 
            "WHEEL", "JUSTICE", "HANGED", "DEATH", "TEMPERANCE", 
            "DEVIL", "TOWER", "STAR", "MOON", "SUN", "JUDGEMENT", "WORLD"
        ];

        const cards = [];
        const geometry = new THREE.BoxGeometry(1.2, 2, 0.05);

        // Fungsi bikin tekstur kartu neon
        function createTextTexture(text) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // Background
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,256,400);
            // Border
            ctx.strokeStyle = '#0ff'; ctx.lineWidth = 5; ctx.strokeRect(10,10,236,380);
            // Text
            ctx.fillStyle = '#fff'; ctx.font = 'bold 30px Arial'; ctx.textAlign = 'center';
            ctx.fillText(text, 128, 200);
            
            const tex = new THREE.CanvasTexture(canvas);
            return new THREE.MeshStandardMaterial({ map: tex, emissive: 0x004444, metalness: 0.8, roughness: 0.2 });
        }

        const backMat = new THREE.MeshStandardMaterial({ color: 0x222, emissive: 0x220022 });
        const edgeMat = new THREE.MeshStandardMaterial({ color: 0x0ff });

        cardData.forEach((name, i) => {
            const mat = createTextTexture(name);
            // Kanan, Kiri, Atas, Bawah, Depan, Belakang
            const mesh = new THREE.Mesh(geometry, [edgeMat, edgeMat, edgeMat, edgeMat, mat, backMat]);
            mesh.userData = { id: i, name: name, selected: false };
            
            // Posisi awal numpuk
            mesh.position.y = i * 0.02; 
            scene.add(mesh);
            cards.push(mesh);
        });

        // Cursor (Jari Telunjuk)
        const cursorGeo = new THREE.SphereGeometry(0.15, 16, 16);
        const cursorMat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
        const cursor = new THREE.Mesh(cursorGeo, cursorMat);
        cursor.position.z = 2; // Muncul di depan
        scene.add(cursor);

        // --- LOGIC ---
        let handX = 0, handY = 0;
        let isFist = false;
        let mode = 'stack'; // 'stack', 'wheel', 'select'
        let time = 0;

        // --- HAND TRACKING ---
        const video = document.createElement('video');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                handX = lm[8].x; // Jari telunjuk ujung
                handY = lm[8].y;
                
                // Cek Fist: Jarak jari telunjuk (8) ke pergelangan tangan (0)
                const dx = lm[8].x - lm[0].x;
                const dy = lm[8].y - lm[0].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                // Kalau jarak dekat = genggam
                const fistNow = dist < 0.2;

                if (fistNow && !isFist && mode === 'wheel') {
                    mode = 'select';
                    selectCard();
                }
                if (!fistNow && isFist && mode === 'select') {
                    mode = 'wheel';
                    resetCard();
                }
                isFist = fistNow;

                // Trigger Buka Deck kalau tangan di pinggir kiri layar
                if (mode === 'stack' && handX < 0.2) {
                    mode = 'wheel';
                }
            }
        });

        function selectCard() {
            // Cari kartu terdekat dengan cursor
            let minDist = 999;
            let target = null;
            cards.forEach(c => {
                const d = c.position.distanceTo(cursor.position);
                if(d < minDist) { minDist = d; target = c; }
            });
            if(target) {
                target.userData.selected = true;
                // Efek Zoom
                target.position.set(0, 0, 3);
                target.scale.set(1.5, 1.5, 1.5);
            }
        }

        function resetCard() {
            cards.forEach(c => {
                c.userData.selected = false;
                c.scale.set(1, 1, 1);
            });
        }

        // --- ANIMASI ---
        function animate() {
            requestAnimationFrame(animate);
            time += 0.02;

            // Gerakin Cursor sesuai Tangan
            // Map 0-1 ke -5 s/d 5
            const targetX = (handX - 0.5) * 10;
            const targetY = -(handY - 0.5) * 5;
            
            cursor.position.x += (targetX - cursor.position.x) * 0.2;
            cursor.position.y += (targetY - cursor.position.y) * 0.2;

            cards.forEach((c, i) => {
                if (mode === 'stack') {
                    // Balik ke tumpukan
                    c.position.x += (0 - c.position.x) * 0.1;
                    c.position.y += (i*0.02 - c.position.y) * 0.1;
                    c.position.z += (0 - c.position.z) * 0.1;
                    c.rotation.z += (0 - c.rotation.z) * 0.1;
                } 
                else if (mode === 'wheel') {
                    // Bentuk Lingkaran
                    const angle = (i / cards.length) * Math.PI * 2 + time * 0.5; // Putar pelan
                    const radius = 4;
                    
                    const tx = Math.sin(angle) * radius;
                    const ty = Math.cos(angle) * (radius * 0.4);
                    const tz = Math.cos(angle) * 1;

                    c.position.x += (tx - c.position.x) * 0.05;
                    c.position.y += (ty - c.position.y) * 0.05;
                    c.position.z += (tz - c.position.z) * 0.05;

                    // Hadap luar
                    c.rotation.y = -angle + Math.PI/2; 
                    c.rotation.x = Math.sin(angle) * 0.2;
                }
                else if (mode === 'select') {
                    if(!c.userData.selected) {
                        c.position.z = -5; // Sembunyikan yang lain
                    } else {
                        // Spin kartu yang terpilih
                        c.rotation.y += 0.05;
                    }
                }
            });

            renderer.render(scene, camera);
        }
        animate();

         // --- START BUTTON (Versi Deteksi Masalah) ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            const btn = document.getElementById('start-btn');
            const ui = document.getElementById('ui');
            
            try {
                // Coba paksa minta izin kamera depan
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { exact: "user" }, // Paksa harus 'user'
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                video.srcObject = stream;
                await video.play();

                // Kalau sampai sini berarti Kamera SUKSES menyala
                btn.style.display = 'none';
                ui.style.display = 'block';
                ui.innerText = "âœ… Kamera Aktif! Gerakkan Tangan...";

                // Jalankan MediaPipe
                const cameraUtils = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 640, 
                    height: 480
                });
                cameraUtils.start();

            } catch (error) {
                // Kalau error, tampilkan pesan di tombol
                console.error(error);
                btn.innerText = "ERROR: IZIN KAMERA DITOLAK!";
                btn.style.background = "red";
                btn.style.color = "white";
                
                // Jelaskan penyebabnya
                ui.style.display = 'block';
                ui.innerText = "Cek: 1. Browser Chrome? 2. Izinkan Kamera? 3. Jangan pakai Incognito?";
            }
        });

    </script>
</body>
</html>
